/*
 * LEAF Visual Novel System For X
 * (c) Copyright 1999,2000 Go Watanabe mailto:go@denpa.org
 * All rights reserverd.
 *
 * ORIGINAL LVNS (c) Copyright 1996-1999 LEAF/AQUAPLUS Inc.
 *
 * $Id: sin_effect.c,v 1.6 2001/07/25 14:36:49 tf Exp $
 */

#include <stdio.h>
#include <stdlib.h>
#include "Lvns.h"

/* うねうね用 sin table (0-360) */
#ifndef USE_MGL
static int
sintable[] = {
	0,2,5,8,11,13,16,19,22,25,27,30,33,35,38,41,44,46,49,52,54,57,59,62,65,67,70,72,75,77,79,82,84,87,89,91,94,96,98,100,102,104,107,109,111,113,115,117,118,120,122,124,126,127,129,131,132,134,135,137,138,139,141,142,143,145,146,147,148,149,150,151,152,153,153,154,155,155,156,157,157,158,158,158,159,159,159,159,159,159,160,159,159,159,159,159,159,158,158,158,157,157,156,155,155,154,153,153,152,151,150,149,148,147,146,145,143,142,141,139,138,137,135,134,132,131,129,127,126,124,122,120,118,117,115,113,111,109,107,104,102,100,98,96,94,91,89,87,84,82,80,77,75,72,70,67,65,62,59,57,54,52,49,46,44,41,38,35,33,30,27,25,22,19,16,13,11,8,5,2,0,-2,-5,-8,-11,-13,-16,-19,-22,-25,-27,-30,-33,-35,-38,-41,-44,-46,-49,-52,-54,-57,-59,-62,-65,-67,-70,-72,-75,-77,-80,-82,-84,-87,-89,-91,-94,-96,-98,-100,-102,-104,-107,-109,-111,-113,-115,-117,-118,-120,-122,-124,-126,-127,-129,-131,-132,-134,-135,-137,-138,-139,-141,-142,-143,-145,-146,-147,-148,-149,-150,-151,-152,-153,-153,-154,-155,-155,-156,-157,-157,-158,-158,-158,-159,-159,-159,-159,-159,-159,-160,-159,-159,-159,-159,-159,-159,-158,-158,-158,-157,-157,-156,-155,-155,-154,-153,-153,-152,-151,-150,-149,-148,-147,-146,-145,-143,-142,-141,-139,-138,-137,-135,-134,-132,-131,-129,-127,-126,-124,-122,-120,-118,-117,-115,-113,-111,-109,-107,-104,-102,-100,-98,-96,-94,-91,-89,-87,-84,-82,-80,-77,-75,-72,-70,-67,-65,-62,-59,-57,-54,-52,-49,-46,-44,-41,-38,-35,-33,-30,-27,-25,-22,-19,-16,-13,-11,-8,-5,-2, 0
};
#define SINTABLESIZE (sizeof sintable/sizeof sintable[0])
#else
const char pos[] = {
	/* 振幅10 (idx = 0-199)*/
	0,0,0,0,0,1,1,1,2,2,2,3,3,3,3,4,4,4,5,5,5,5,6,6,6,6,7,7,7,7,7,8,8,8,8,8,
	8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,
	8,7,7,7,7,7,6,6,6,6,5,5,5,5,4,4,4,3,3,3,3,2,2,2,1,1,1,0,0,0,0,0,0,0,-1,
	-1,-1,-2,-2,-2,-3,-3,-3,-3,-4,-4,-4,-5,-5,-5,-5,-6,-6,-6,-6,-7,-7,-7,-7,
	-7,-8,-8,-8,-8,-8,-8,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-10,-9,-9,
	-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-8,-8,-8,-8,-8,-8,-7,-7,-7,-7,-7,-6,
	-6,-6,-6,-5,-5,-5,-5,-4,-4,-4,-3,-3,-3,-3,-2,-2,-2,-1,-1,-1,0,0,

	/* 振幅20 ( idx = 200-399)*/
	0,0,0,1,1,2,3,3,4,4,5,6,6,7,7,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,
	15,16,16,16,17,17,17,18,18,18,18,19,19,19,19,19,19,19,19,19,19,20,19,19,
	19,19,19,19,19,19,19,19,18,18,18,18,17,17,17,16,16,16,15,15,15,14,14,13,
	13,12,12,11,11,10,10,9,9,8,7,7,6,6,5,4,4,3,3,2,1,1,0,0,0,-1,-1,-2,-3,-3,
	-4,-4,-5,-6,-6,-7,-7,-8,-9,-9,-10,-10,-11,-11,-12,-12,-13,-13,-14,-14,
	-15,-15,-15,-16,-16,-16,-17,-17,-17,-18,-18,-18,-18,-19,-19,-19,-19,-19,
	-19,-19,-19,-19,-19,-20,-19,-19,-19,-19,-19,-19,-19,-19,-19,-19,-18,-18,
	-18,-18,-17,-17,-17,-16,-16,-16,-15,-15,-15,-14,-14,-13,-13,-12,-12,-11,
	-11,-10,-10,-9,-9,-8,-7,-7,-6,-6,-5,-4,-4,-3,-3,-2,-1,-1,

	/* 振幅30 (idx = 400-599) */
	0,0,0,1,2,3,4,5,6,7,8,9,10,11,11,12,13,14,15,16,16,17,18,19,19,20,21,21,
	22,23,23,24,24,25,25,26,26,27,27,27,28,28,28,29,29,29,29,29,29,29,29,30,
	29,29,29,29,29,29,29,29,28,28,28,27,27,27,26,26,25,25,24,24,23,23,22,21,
	21,20,19,19,18,17,16,16,15,14,13,12,11,11,10,9,8,7,6,5,4,3,2,1,0,0,0,-1,
	-2,-3,-4,-5,-6,-7,-8,-9,-10,-11,-11,-12,-13,-14,-15,-16,-16,-17,-18,-19,
	-19,-20,-21,-21,-22,-23,-23,-24,-24,-25,-25,-26,-26,-27,-27,-27,-28,-28,
	-28,-29,-29,-29,-29,-29,-29,-29,-29,-30,-29,-29,-29,-29,-29,-29,-29,-29,
	-28,-28,-28,-27,-27,-27,-26,-26,-25,-25,-24,-24,-23,-23,-22,-21,-21,-20,
	-19,-19,-18,-17,-16,-16,-15,-14,-13,-12,-11,-11,-10,-9,-8,-7,-6,-5,-4,
	-3,-2,-1,

	/* 振幅40 (idx = 600-799)*/
	0,0,1,2,3,5,6,7,8,9,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,
	29,30,30,31,32,33,33,34,35,35,36,36,37,37,38,38,38,39,39,39,39,39,39,39,
	40,39,39,39,39,39,39,39,38,38,38,37,37,36,36,35,35,34,33,33,32,31,30,30,
	29,28,27,26,25,24,23,22,21,20,19,18,17,15,14,13,12,11,9,8,7,6,5,3,2,1,0,
	-1,-2,-3,-5,-6,-7,-8,-9,-11,-12,-13,-14,-15,-17,-18,-19,-20,-21,-22,-23,
	-24,-25,-26,-27,-28,-29,-30,-30,-31,-32,-33,-33,-34,-35,-35,-36,-36,-37,
	-37,-38,-38,-38,-39,-39,-39,-39,-39,-39,-39,-40,-39,-39,-39,-39,-39,-39,
	-39,-38,-38,-38,-37,-37,-36,-36,-35,-35,-34,-33,-33,-32,-31,-30,-30,-29,
	-28,-27,-26,-25,-24,-23,-22,-21,-20,-19,-18,-17,-15,-14,-13,-12,-11,-9,
	-8,-7,-6,-5,-3,-2,

	/* 振幅50 (idx = 800-999)*/
	0,0,1,3,4,6,7,9,10,12,13,15,16,18,19,21,22,24,25,26,28,29,30,31,33,34,35,
	36,37,38,39,40,41,42,43,43,44,45,45,46,47,47,48,48,48,49,49,49,49,49,49,
	50,49,49,49,49,49,49,48,48,48,47,47,46,45,45,44,43,43,42,41,40,39,38,37,
	36,35,34,33,31,30,29,28,26,25,24,22,21,19,18,16,15,13,12,10,9,7,6,4,3,1,
	0,-1,-3,-4,-6,-7,-9,-10,-12,-13,-15,-16,-18,-19,-21,-22,-24,-25,-26,-28,
	-29,-30,-31,-33,-34,-35,-36,-37,-38,-39,-40,-41,-42,-43,-43,-44,-45,-45,
	-46,-47,-47,-48,-48,-48,-49,-49,-49,-49,-49,-49,-50,-49,-49,-49,-49,-49,
	-49,-48,-48,-48,-47,-47,-46,-45,-45,-44,-43,-43,-42,-41,-40,-39,-38,-37,
	-36,-35,-34,-33,-31,-30,-29,-28,-26,-25,-24,-22,-21,-19,-18,-16,-15,-13,
	-12,-10,-9,-7,-6,-4,-3,

	/* 振幅60 (idx = 1000-1199)*/
	0,0,1,3,5,7,9,11,13,14,16,18,20,22,23,25,27,28,30,32,33,35,36,38,39,41,
	42,43,45,46,47,48,49,50,51,52,53,54,55,55,56,57,57,58,58,58,59,59,59,59,
	59,60,59,59,59,59,59,58,58,58,57,57,56,55,55,54,53,52,51,50,49,48,47,46,
	45,43,42,41,39,38,36,35,33,32,30,28,27,25,23,22,20,18,16,14,13,11,9,7,5,
	3,1,0,-1,-3,-5,-7,-9,-11,-13,-14,-16,-18,-20,-22,-23,-25,-27,-28,-30,-32,
	-33,-35,-36,-38,-39,-41,-42,-43,-45,-46,-47,-48,-49,-50,-51,-52,-53,-54,
	-55,-55,-56,-57,-57,-58,-58,-58,-59,-59,-59,-59,-59,-60,-59,-59,-59,-59,
	-59,-58,-58,-58,-57,-57,-56,-55,-55,-54,-53,-52,-51,-50,-49,-48,-47,-46,
	-45,-43,-42,-41,-39,-38,-36,-35,-33,-32,-30,-28,-27,-25,-23,-22,-20,-18,
	-16,-14,-13,-11,-9,-7,-5,-3,

	/* 振幅80 (idx = 1200-1399)*/
	0,0,2,5,7,10,12,14,17,19,22,24,27,29,31,34,36,38,40,42,44,47,49,50,52,54,
	56,58,60,61,63,64,66,67,68,70,71,72,73,74,75,76,76,77,78,78,79,79,79,79,79,
	80,79,79,79,79,79,78,78,77,76,76,75,74,73,72,71,70,68,67,66,64,63,61,60,58,
	56,54,52,50,49,47,44,42,40,38,36,34,31,29,27,24,22,19,17,14,12,10,7,5,2,0,
	-2,-5,-7,-10,-12,-14,-17,-19,-22,-24,-27,-29,-31,-34,-36,-38,-40,-42,-44,
	-47,-49,-50,-52,-54,-56,-58,-60,-61,-63,-64,-66,-67,-68,-70,-71,-72,-73,-74,
	-75,-76,-76,-77,-78,-78,-79,-79,-79,-79,-79,-80,-79,-79,-79,-79,-79,-78,-78,
	-77,-76,-76,-75,-74,-73,-72,-71,-70,-68,-67,-66,-64,-63,-61,-60,-58,-56,-54,
	-52,-50,-49,-47,-44,-42,-40,-38,-36,-34,-31,-29,-27,-24,-22,-19,-17,-14,-12,
	-10,-7,-5,

};

static u_long prev = 0;
#endif

/*
 * うねうね
 */

/* 状態遷移 */
static void
SinEffectSetState(Lvns *lvns)
{
#ifndef USE_MGL
    lvns->effect_back_state += 8;
    if (lvns->effect_back_state >= SINTABLESIZE) 
        lvns->effect_back_state -= SINTABLESIZE;
#else
    if( (lvns->effect_back_state += 10) >= 1400){
      lvns->effect_back_state = 800;
    }
#endif
}    

/* 
 * 描画処理 
 * 実は不完全。起動してからじょじょに振幅があがるようにしないと…
 * …わざわざ整数処理する価値あるかな(^^;
 */
#ifndef USE_MGL
static void
SinEffect(Lvns *lvns)
{
    int i, p;
    lvnsimage_copy_palette(lvns->background, lvns->vram);
    for (p=lvns->effect_back_state,i=0; i<400; i++) {
        if (sintable[p] > 0) {
            lvnsimage_copy_area(lvns->background, lvns->vram,
                                sintable[p], i,  
                                640 - sintable[p], 1, 0, i);
            lvnsimage_clear_area(lvns->vram,
                                 640 - sintable[p], i, sintable[p], 1);
        } else {
            lvnsimage_clear_area(lvns->vram,
                                 0, i, -sintable[p], 1);
            lvnsimage_copy_area(lvns->background, lvns->vram,
                                 0, i,  
                                 640 + sintable[p], 1, -sintable[p], i);
        }
        if (++p >= SINTABLESIZE)
            p = 0;
    }
    LVNS->mergeCharacter(lvns);
}   
#else
static void
SinEffect(Lvns *lvns)
{
    int x, y;

    for (y = 0; y < 200; y++) {
      x = y + lvns->effect_back_state;
      
      if (x >= 1400) {
	x -= 600;
      }
      x = pos[x];
      
      if (x > 0){
	lvnsimage_clear_area(lvns->vram, 0, y, x, 1);
	
	lvnsimage_copy_area(lvns->background, lvns->vram, 0, y, 320 - x, 1, x, y);
      } else {
	lvnsimage_copy_area(lvns->background, lvns->vram, -x, y, 320 + x, 1, 0, y);
	
	lvnsimage_clear_area(lvns->vram, 320 + x, y, -x, 1);
      }
    }
}
#endif

LvnsBackEffectInfo lvnsSinEffect = {
    SinEffectSetState,
    SinEffect
};


